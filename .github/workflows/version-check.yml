name: Rust Version Check (Pre-Merge)

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read

jobs:
  check-version:
    runs-on: ubuntu-latest

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
      with:
        egress-policy: audit

    - name: Checkout code
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

    - name: Set up Rust
      uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7e13fa3af # v1.0.7
      with:
        toolchain: stable
        override: true

    - name: Extract version from Cargo.toml
      id: get-version
      run: |
        VERSION=$(grep '^version =' Cargo.toml | head -n 1 | sed 's/version = "\(.*\)"/\1/')
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Package version: $VERSION"

    - name: Check if tag exists for the version
      run: |
        git fetch --tags
        if git rev-parse "$VERSION" >/dev/null 2>&1; then
          echo "Git tag for version $VERSION already exists!"
          exit 1
        else
          echo "No existing tag found for version $VERSION."
        fi
