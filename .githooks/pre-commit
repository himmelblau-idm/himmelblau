#!/bin/bash
#
# Git pre-commit hook for Himmelblau
#
# This hook runs automatically before each commit and handles:
#   1. SELinux policy tests - when SELinux policy files are changed
#   2. NixOS options regeneration - when XML definitions are changed
#
# To install this hook, run from the repository root:
#   git config core.hooksPath .githooks
#
# Or use the Makefile target:
#   make setup-hooks

set -e

# Get the repository root directory
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

###############################################################################
# SELinux Policy Tests
###############################################################################

# Check if any staged files match the SELinux policy files
SELINUX_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^src/selinux/src/himmelblaud\.(te|fc)$' || true)

if [ -n "$SELINUX_FILES" ]; then
    echo "SELinux policy files changed:"
    echo "$SELINUX_FILES"
    echo ""
    echo "Running SELinux policy tests..."
    echo ""

    # Run the SELinux test
    if ! make -C "$REPO_ROOT" test-selinux; then
        echo ""
        echo "ERROR: SELinux policy test failed!"
        echo ""
        echo "Please fix the policy issues before committing."
        echo "You can run 'make test-selinux' to see detailed output."
        echo ""
        echo "To bypass this check (not recommended), use: git commit --no-verify"
        exit 1
    fi

    echo ""
    echo "SELinux policy tests passed."
fi

###############################################################################
# NixOS Options and Man Page Regeneration
###############################################################################

# Files/directories that trigger regeneration
WATCHED_PATHS=(
    "docs-xml/himmelblauconf/"
    "scripts/gen_param_code.py"
)

# Output files that get regenerated
NIX_OUTPUT="nix/modules/himmelblau-options.nix"
MAN_OUTPUT="man/man5/himmelblau.conf.5"
GENERATOR_SCRIPT="scripts/gen_param_code.py"

# Check if any watched paths have staged changes
needs_regeneration() {
    for path in "${WATCHED_PATHS[@]}"; do
        if git diff --cached --name-only | grep -q "^${path}"; then
            return 0
        fi
    done
    return 1
}

# Check if the generator script exists
check_generator() {
    if [[ ! -f "$GENERATOR_SCRIPT" ]]; then
        echo "Error: Generator script not found: $GENERATOR_SCRIPT" >&2
        exit 1
    fi
}

# Stage a file if it has changes
stage_if_changed() {
    local file="$1"
    if git diff --quiet "$file" 2>/dev/null; then
        echo "  $file: no changes"
    else
        git add "$file"
        echo "  $file: staged"
    fi
}

# Main logic for regeneration
if needs_regeneration; then
    echo "Detected changes to XML definitions or generator script."
    echo "Regenerating NixOS options and man page..."

    check_generator

    # Run the generator for both NixOS options and man page (suppress progress messages)
    if python3 "$GENERATOR_SCRIPT" \
        --gen-nix --nix-output "$NIX_OUTPUT" \
        --gen-man --man-output "$MAN_OUTPUT" \
        2>/dev/null; then

        echo "Regeneration complete:"
        stage_if_changed "$NIX_OUTPUT"
        stage_if_changed "$MAN_OUTPUT"
    else
        echo "Error: Failed to regenerate files" >&2
        exit 1
    fi
fi

exit 0
