#!/usr/bin/env python3
"""
Himmelblau Dockerfile generator

Usage:
  python gen_dockerfiles.py [--out ./dockerfiles] [--only debian12,ubuntu22.04]

This follows a config-driven pattern inspired by Samba's bootstrap/config.py:
- deb family => cargo deb chain with per-package feature flags and --deb-revision=<distro>
- rpm/zypper family => cargo build + strip + cargo generate-rpm chain
- Per-distro toggle for the "interactive" feature (some distros cannot build with it)
"""
import os, sys, argparse

GENERATED_MARKER = """\
#
# This file is generated by gen_dockerfiles.py
# Do not edit by hand â€” update the generator or config instead.
#
"""

# ---- Package config ----------------------------------------------------------

COMMON = [
    "git",
    "curl",
    "wget",
    "make",
    "pkg-config",
    "jq",
    "ca-certificates",
    "libtool",
    "autoconf",
    "gettext",
    "checkpolicy",
    "policycoreutils",
]

PKG_PAIRS = [
    ("build-essential", "@development-tools"),
    ("gcc", "gcc"),
    ("g++", "gcc-c++"),
    ("libssl-dev", "openssl-devel"),
    ("libdbus-1-dev", "dbus-devel"),
    ("libkrb5-dev", "krb5-devel"),
    ("libpam0g-dev", "pam-devel"),
    ("libcap-dev", "libcap-devel"),
    ("libudev-dev", "libudev-devel"),
    ("cmake", "cmake"),
    ("libtss2-dev tpm-udev", "tpm2-tss-devel"),
    ("libclang-dev", "clang"),
    ("libpcre2-dev", "pcre2-devel"),
    ("libsqlite3-dev", "sqlite-devel"),
    ("libunistring-dev", "libunistring-devel"),
    ("policycoreutils-dev", "policycoreutils-devel"),
    # Interactive feature only
    ("libgirepository1.0-dev", "gobject-introspection-devel"),
    ("libcairo2-dev", "cairo-devel"),
    ("libgdk-pixbuf2.0-dev", "gdk-pixbuf-devel"),
    ("libsoup-3.0-dev", "libsoup-devel"),
    ("libpango1.0-dev", "pango-devel"),
    ("libatk1.0-dev", "atk-devel"),
    ("libgtk-3-dev", "gtk3-devel"),
    ("libwebkit2gtk-4.1-dev", "webkit2gtk3-devel"),
    ("libjavascriptcoregtk-4.1-dev", "javascriptcoregtk4.1-devel"),
]

DEB_PKGS = COMMON + [p for p, _ in PKG_PAIRS if p]
RPM_PKGS = COMMON + [q for _, q in PKG_PAIRS if q]

APT_BOOTSTRAP = """\
RUN apt-get update && apt-get install -y \\\n    {pkgs} \\\n && rm -rf /var/lib/apt/lists/*\n"""

DNF_BOOTSTRAP = """\
RUN dnf -y update && dnf -y install \\\n    {pkgs} \\\n && dnf clean all\n"""

ZYPPER_BOOTSTRAP = """\
RUN zypper --non-interactive refresh && \\\n    zypper --non-interactive update && \\\n    zypper --non-interactive install --no-recommends \\\n        {pkgs} && \\\n    zypper clean --all\n"""

FAMILIES = {
    "deb": {
        "bootstrap": APT_BOOTSTRAP,
        "pkgs": DEB_PKGS,
        "env": "ENV DEBIAN_FRONTEND=noninteractive",
    },
    "rpm": {
        "bootstrap": DNF_BOOTSTRAP,
        "pkgs": RPM_PKGS,
        "env": None,
    },
    "zypper": {
        "bootstrap": ZYPPER_BOOTSTRAP,
        "pkgs": RPM_PKGS,
        "env": None,
    },
}

# ---- Final command builders --------------------------------------------------

PACKAGES = [
    # (crate name, crate source, needs_tpm_feature)
    ("himmelblaud", "src/daemon", True),
    ("nss_himmelblau", "src/nss", True),
    ("pam_himmelblau", "src/pam", True),
    ("sshd-config", "src/sshd-config", False),
    ("sso", "src/sso", True),
    ("qr-greeter", "src/qr-greeter", False),
    ("selinux", "src/selinux", False),
]


def build_deb_final_cmd(features: list, distro_slug: str) -> str:
    parts = []
    for pkg, _, needs_tpm in PACKAGES:
        if not needs_tpm and "tpm" in features:
            features.remove("tpm")
        feat_str = " --features %s" % ",".join(features) if len(features) > 0 else ""
        parts.append(f"cargo deb{feat_str} --deb-revision={distro_slug} -p {pkg}")
    return "CMD " + " && ".join(parts)


def build_rpm_final_cmd(features: list) -> str:
    feat_str = " --features %s" % ",".join(features) if len(features) > 0 else ""
    build = f"cargo build --release{feat_str}"
    strip = "strip -s target/release/*.so && strip -s target/release/aad-tool && strip -s target/release/himmelblaud && strip -s target/release/himmelblaud_tasks && strip -s target/release/broker"
    rpms = " && ".join(
        ["cargo generate-rpm -p %s" % source for _, source, _ in PACKAGES]
    )
    return "CMD " + " && ".join([build, strip, rpms])


# ---- Distro targets ----------------------------------------------------------

DISTS = {
    # ---- Debian family ----
    "debian12": {
        "family": "deb",
        "image": "debian:12",
        "replace": {
            "@development-tools": "",
        },
        "interactive": False,
        "tpm": True,
    },
    "debian13": {
        "family": "deb",
        "image": "debian:13",
        "replace": {
            "@development-tools": "",
            "libgdk-pixbuf2.0-dev": "libgdk-pixbuf-xlib-2.0-dev",
        },
        "interactive": False,
        "tpm": True,
    },
    "ubuntu22.04": {
        "family": "deb",
        "image": "ubuntu:22.04",
        "interactive": False,
        "tpm": True,
    },
    "ubuntu24.04": {
        "family": "deb",
        "image": "ubuntu:24.04",
        "interactive": False,
        "tpm": True,
    },
    # ---- Fedora family ----
    "fedora41": {
        "family": "rpm",
        "image": "fedora:41",
        "replace": {
            "gdk-pixbuf-devel": "",
            "webkit2gtk3-devel": "webkit2gtk4.1-devel",
        },
        "interactive": True,
        "tpm": True,
    },
    "fedora42": {
        "family": "rpm",
        "image": "fedora:42",
        "replace": {
            "gdk-pixbuf-devel": "",
            "webkit2gtk3-devel": "webkit2gtk4.1-devel",
        },
        "interactive": True,
        "tpm": True,
    },
    "rawhide": {
        "family": "rpm",
        "image": "fedora:rawhide",
        "replace": {
            "gdk-pixbuf-devel": "",
            "webkit2gtk3-devel": "webkit2gtk4.1-devel",
        },
        "interactive": True,
        "tpm": True,
    },
    # ---- Rocky family ----
    "rocky8": {
        "family": "rpm",
        "image": "rockylinux:8",
        "extra_prep": [
            "RUN dnf -y install 'dnf-command(config-manager)' && dnf config-manager --set-enabled powertools"
        ],
        "replace": {
            "build-essential": '"@Development Tools"',
            "@development-tools": "",
            "gobject-introspection-devel": "",
            "cairo-devel": "",
            "gdk-pixbuf-devel": "",
            "libsoup-devel": "",
            "pango-devel": "",
            "atk-devel": "",
            "gtk3-devel": "",
            "webkit2gtk3-devel": "",
            "javascriptcoregtk4.1-devel": "",
        },
        "interactive": False,
        "tpm": False,
    },
    "rocky9": {
        "family": "rpm",
        "image": "rockylinux:9",
        "extra_prep": [
            "RUN dnf -y install 'dnf-command(config-manager)' && dnf config-manager --set-enabled crb"
        ],
        "replace": {
            "build-essential": '"@Development Tools"',
            "@development-tools": "",
            "gobject-introspection-devel": "",
            "cairo-devel": "",
            "gdk-pixbuf-devel": "",
            "libsoup-devel": "",
            "pango-devel": "",
            "atk-devel": "",
            "gtk3-devel": "",
            "webkit2gtk3-devel": "",
            "javascriptcoregtk4.1-devel": "",
            "curl": "",  # avoid the curl/curl-minimal install conflict
        },
        "interactive": False,
        "tpm": True,
    },
    "rocky10": {
        "family": "rpm",
        "image": "rockylinux:10",
        "extra_prep": [
            "RUN dnf install -y 'dnf-command(config-manager)' && dnf config-manager --set-enabled crb"
        ],
        "replace": {
            "build-essential": '"@Development Tools"',
            "@development-tools": "",
            "gobject-introspection-devel": "",
            "cairo-devel": "",
            "gdk-pixbuf-devel": "",
            "libsoup-devel": "",
            "pango-devel": "",
            "atk-devel": "",
            "gtk3-devel": "",
            "webkit2gtk3-devel": "",
            "javascriptcoregtk4.1-devel": "",
        },
        "interactive": False,
        "tpm": True,
    },
    # ---- SUSE family ----
    "sle15sp6": {
        "family": "zypper",
        "image": "registry.suse.com/suse/sle15:15.6",
        "scc": True,
        "scc_vers": "15.6",
        "replace": {
            "build-essential": "",
            "@development-tools": "",
            "dbus-devel": "dbus-1-devel",
            "tpm2-tss-devel": "tpm2-0-tss-devel",
            "sqlite-devel": "sqlite3-devel",
            "javascriptcoregtk4.1-devel": "",
        },
        "interactive": False,
        "tpm": True,
    },
    "sle15sp7": {
        "family": "zypper",
        "image": "registry.suse.com/suse/sle15:15.7",
        "scc": True,
        "scc_vers": "15.7",
        "replace": {
            "build-essential": "",
            "@development-tools": "",
            "dbus-devel": "dbus-1-devel",
            "tpm2-tss-devel": "tpm2-0-tss-devel",
            "sqlite-devel": "sqlite3-devel",
            "javascriptcoregtk4.1-devel": "",
            "clang": "clang7",
        },
        "interactive": False,
        "tpm": True,
    },
    "sle16": {
        "family": "zypper",
        "image": "registry.suse.com/bci/bci-sle16-kernel-module-devel:16.0",
        "scc": True,
        "scc_vers": "16.0",
        "replace": {
            "build-essential": "",
            "@development-tools": "",
            "dbus-devel": "dbus-1-devel",
            "tpm2-tss-devel": "tpm2-0-tss-devel",
            "sqlite-devel": "sqlite3-devel",
            "javascriptcoregtk4.1-devel": "",
        },
        "interactive": False,
        "tpm": True,
    },
    "tumbleweed": {
        "family": "zypper",
        "image": "opensuse/tumbleweed:latest",
        "replace": {
            "build-effective": "",
            "@development-tools": "",
            "dbus-devel": "dbus-1-devel",
            "tpm2-tss-devel": "tpm2-0-tss-devel",
            "sqlite-devel": "sqlite3-devel",
            "javascriptcoregtk4.1-devel": "",
        },
        "interactive": True,
        "tpm": True,
    },
}

DOCKERFILE_TPL = """\
{GENERATED_MARKER}FROM {base_image}
{env}
{sle_connect}

# Install essential build dependencies
{bootstrap}

# Install Rust (latest stable)
RUN curl https://sh.rustup.rs -sSf | sh -s -- -y

# Set environment for Rust
ENV PATH="/root/.cargo/bin:${{PATH}}"

# Project layout
VOLUME /himmelblau

# Change directory to the repository
WORKDIR /himmelblau

# Install the cargo-deb and cargo-generate-rpm tools
RUN cargo install cargo-deb cargo-generate-rpm

# Build the project and create the packages
{final_cmd}
"""

SLE_CONNECT_TPL = """\
# Install SUSEConnect and dependencies for registration
RUN zypper --non-interactive refresh && \\
    zypper --non-interactive install --no-recommends \\
        SUSEConnect \\
        ca-certificates \\
        suse-build-key && \\
    zypper clean --all

RUN --mount=type=secret,id=scc_regcode,dst=/run/secrets/scc_regcode \\
    set -e && \\
    source /run/secrets/scc_regcode && \\
    SUSEConnect --email "$email" --regcode "$regcode" && \\
    SUSEConnect -p PackageHub/%s/x86_64
"""


def build_pkg_list(dist_cfg):
    fam = FAMILIES[dist_cfg["family"]]
    pkgs = list(fam["pkgs"])
    rep = dist_cfg.get("replace", {})
    out = []
    for p in pkgs:
        q = rep.get(p, p)
        if q:
            out.append(q)
    out = sorted(set(out))
    sep = " \\\n        "
    return sep.join(out)


def render(dist_name, dist_cfg):
    fam = FAMILIES[dist_cfg["family"]]
    pkgs = build_pkg_list(dist_cfg)
    bootstrap = fam["bootstrap"].format(pkgs=pkgs).rstrip()
    env = fam["env"] or ""
    sle_connect = (
        SLE_CONNECT_TPL % dist_cfg.get("scc_vers") if dist_cfg.get("scc") else ""
    )

    # Features
    interactive = bool(dist_cfg.get("interactive", False))
    tpm = bool(dist_cfg.get("tpm", False))
    features = []
    if tpm:
        features.append("tpm")
    if interactive:
        features.append("interactive")

    final_cmd = ""
    if dist_cfg["family"] == "deb":
        final_cmd = build_deb_final_cmd(features, dist_name)
    else:
        final_cmd = build_rpm_final_cmd(features)

    blocks = []
    if dist_cfg.get("extra_prep"):
        blocks.extend(dist_cfg["extra_prep"])
    extra = "\n".join(blocks) + ("\n" if blocks else "")

    df = DOCKERFILE_TPL.format(
        GENERATED_MARKER=GENERATED_MARKER,
        base_image=dist_cfg["image"],
        env=env,
        bootstrap=(extra + bootstrap),
        sle_connect=sle_connect,
        final_cmd=final_cmd,
    )
    return df


def main():
    ap = argparse.ArgumentParser()
    ap.add_argument("--out", default="./dockerfiles", help="Output directory")
    ap.add_argument(
        "--only", default="", help="Comma-separated list of dists to render"
    )
    args = ap.parse_args()

    if args.only:
        want = {x.strip() for x in args.only.split(",") if x.strip()}
    else:
        want = set(DISTS.keys())

    os.makedirs(args.out, exist_ok=True)

    written = []
    for name in sorted(want):
        if name not in DISTS:
            print(f"[skip] unknown dist: {name}")
            continue
        df = render(name, DISTS[name])
        path = os.path.join(args.out, f"Dockerfile.{name}")
        with open(path, "w", encoding="utf-8") as f:
            f.write(df)
        written.append(path)

    print(f"Wrote {len(written)} Dockerfiles:")
    for p in written:
        print("  -", p)


if __name__ == "__main__":
    main()
