.TH HIMMELBLAU.CONF "5" "January 2026" "Himmelblau Configuration" "File Formats"
.SH NAME
himmelblau.conf \- Configuration file for Himmelblau, enabling Azure Entra ID authentication on Linux.

.SH SYNOPSIS
.B /etc/himmelblau/himmelblau.conf

.SH HOW CONFIGURATION CHANGES ARE APPLIED
Changes to the configuration file
.B /etc/himmelblau/himmelblau.conf
only take effect after restarting the Himmelblau daemons. This includes the
.B himmelblaud
daemon, which handles authentication, and the
.B himmelblaud-tasks
daemon, which processes related tasks.

.TP
.B Restarting the Daemons
To apply changes, restart the Himmelblau services using the following systemd commands:

.nf
.RS
.IP
sudo systemctl restart himmelblaud
.IP
sudo systemctl restart himmelblaud-tasks
.RE
.fi

.SH DESCRIPTION
The
.B himmelblau.conf
file is the primary configuration file for the Himmelblau authentication module. It defines global and optional settings required for Azure Entra ID-based authentication and device management.

.P
While Himmelblau is designed to be highly configurable, it can normally be used without any custom configuration. For desktop authentication with Azure Entra ID, all that is required is for Himmelblau to be installed and for a user to log in. The domain will be automatically extracted from the first user's UPN and looked up in Entra ID.

.P
Himmelblau has many capabilities, but most are enabled by default and configured automatically at install time. The options documented below allow administrators to customize behavior for specific environments or requirements.

.SH FILE FORMAT
The file consists of sections headed by a name enclosed in square brackets. Each section contains parameters and their values in the format:
.RS 4
parameter = value
.RE

Lines beginning with a '#' are comments and are ignored by the parser.

.SH PARAMETERS

.SS [global]
This section contains settings that apply globally to all operations of Himmelblau.

.TP
.B domain
.RE
The primary Azure Entra ID domain name used for authentication. This value
.B SHOULD
match the domain name that users enter when signing in (for example, the domain portion of their UPN).

In most cases, this will be the primary domain of your Azure Entra ID tenant. If your organization uses multiple verified domains or aliases, choose the one that your users actually use to sign in.

If not specified, the domain is extracted from the UPN of the first user to authenticate and looked up in Entra ID.

.P
Default: Extracted from first user's UPN

.P
Example: domain = example.com

.TP
.B oidc_issuer_url
.RE
Specifies the OpenID Connect (OIDC) issuer URL used by Himmelblau to discover
OIDC provider metadata and endpoints.

This option enables generic OIDC authentication support and allows Himmelblau
to authenticate against any standards-compliant OIDC provider, rather than
using the built-in Microsoft Entra ID defaults.

When this option is set, the following option is
.B REQUIRED
and must be configured consistently:
.RS
.IP \(bu 2
.B app_id
\(en Used as the OIDC client identifier
.RE

The issuer URL
.B MUST
exactly match the issuer value advertised by the OIDC provider, including
any required path components.
Incorrect issuer URLs will cause provider discovery to fail.

If this option is not set, Himmelblau defaults to its native Microsoft Entra ID
authentication flow.

.P
Example: oidc_issuer_url = https://login.microsoftonline.com/0656e57d-a8fc-4aa4-8366-8045787115ca/v2.0

.TP
.B debug
.RE
A boolean option that enables debug-level logging. When set to
.B true,
debug messages are output to the system journal.

.P
Default: false

.P
Example: debug = true

.TP
.B pam_allow_groups
.RE
A comma-separated list of Entra Id Users and Groups permitted to access the system. Users should be specified by UPN. Groups MUST be specified using their Object ID GUID. Group names may not be used because these names are not guaranteed to be unique in Entra Id.

If not set, all Entra ID users are permitted to authenticate.

.P
Default: All users permitted

.P
Example: pam_allow_groups = f3c9a7e4-7d5a-47e8-832f-3d2d92abcd12,5ba4ef1d-e454-4f43-ba7c-6fe6f1601915,admin@himmelblau-idm.org

.TP
.B id_attr_map
.RE
Specify whether to map uid/gid based on the object name, the object uuid, or based on the rfc2307 schema extension attributes synchronized from an on-prem Active Directory instance. Mapping by name or by rfc2307 is recommended.

.P
Default: name

.P
Example: id_attr_map = <name|uuid|rfc2307>

.TP
.B rfc2307_group_fallback_map
.RE
Specify whether to map group IDs (GIDs) based on the object name or object UUID when no
.B gidNumber
attribute is found in an on-prem Active Directory instance synchronized to Azure Entra ID. This option is only applicable if
.B id_attr_map
is set to
.B rfc2307.
If
.B id_attr_map = rfc2307
and a group does not have a
.B gidNumber
defined in the directory, this setting determines the fallback method for mapping the group ID. If this option is not set, groups without a
.B gidNumber
will not be available to NSS.

.P
Example: rfc2307_group_fallback_map = <name|uuid>

.TP
.B enable_hello
.RE
Enables or disables user enrollment in Windows Hello authentication. If disabled, users will need to provide MFA for each login.

.P
Default: true

.P
Example: enable_hello = false

.TP
.B enable_hello_totp
.RE
Enables or disables the use of a local Time-based One-Time Password (TOTP) in combination with Windows Hello authentication. When enabled, users are required to authenticate using both their Hello PIN and a TOTP generated by a standard authenticator application.

The TOTP secret is enrolled and enforced locally on the host and is independent of any cloud-based MFA or identity provider. Users who have not yet enrolled a TOTP secret will be prompted to complete TOTP enrollment.

.P
Default: false

.P
Example: enable_hello_totp = true

.TP
.B hello_pin_min_length
.RE
The minimum length of the PIN for Windows Hello authentication. The value must be between 6 and 32 characters.

.P
Default: 6

.P
Example: hello_pin_min_length = 8

.TP
.B hello_pin_retry_count
.RE
The number of invalid Hello PIN attempts allowed before the user is required to perform MFA. After successful MFA, the user will be prompted to set a new PIN. The value must be a non-negative integer.

.P
Default: 3

.P
Example: hello_pin_retry_count = 5

.TP
.B hello_pin_prompt
.RE
Customizes the prompt text shown when requesting the user's Linux Hello PIN.

.P
Default: Use the Linux Hello PIN for this device.

.P
Example: hello_pin_prompt = Enter your device unlock PIN

.TP
.B entra_id_password_prompt
.RE
Customizes the prompt text shown when requesting the user's Entra ID password.

.P
Default: Use the password for your Office 365 or Microsoft online login.

.P
Example: entra_id_password_prompt = Enter your Microsoft 365 password

.TP
.B enable_sfa_fallback
.RE
Determines whether password-only (single-factor) authentication is permitted when MFA is unavailable.

.P
Default: false

.P
Example: enable_sfa_fallback = true

.TP
.B allow_console_password_only
.RE
Enables password-only (single-factor) authentication for local console logins
(e.g., TTY, GDM, SDDM, LightDM). When enabled, Himmelblau will attempt to authenticate
using only the user's password for local sessions. If Microsoft Entra ID
requires MFA (based on Conditional Access policies), the user will be prompted
for MFA automatically.

This option does
.B NOT
affect remote authentication methods such as SSH, which
always require MFA (unless the user has Hello authentication configured).

Remote connections are detected using multiple signals:
.RS
.IP \(bu 2
PAM_RHOST \- If the remote host is set to a non-localhost value
.IP \(bu 2
PAM_SERVICE \- If the service name matches entries in
.B password_only_remote_services_deny_list
.IP \(bu 2
PAM_TTY \- If the terminal name contains "ssh" (fallback check)
.RE

This option requires the device to be domain-joined, matching the behavior of Microsoft-managed devices. Users can still
use Hello PIN authentication if it is configured. To require MFA for all logins
(including local console), set this option to
.B false.

.P
Default: true

.P
Example: allow_console_password_only = false

.TP
.B password_only_remote_services_deny_list
.RE
A comma-separated list of PAM service names that should always require MFA,
regardless of the
.B allow_console_password_only
setting. These are typically remote access services where password-only
authentication should never be permitted.

The PAM service name is the name passed by the application when calling
.B pam_start()
(e.g., "sshd", "login", "gdm-password").

Entries are matched as substrings, so "ssh" will match "ssh", "sshd", "openssh", etc.

.P
Default: ssh,telnet,ftp,rsh,rlogin,rexec,vnc,xrdp,cockpit,mosh

.P
Example: password_only_remote_services_deny_list = ssh,telnet,vnc,xrdp

.TP
.B mfa_method
.RE
Specifies a preferred MFA (Multi-Factor Authentication) method to use during authentication. When set, Himmelblau will attempt to use this specific MFA method instead of the default method configured in the user's Entra ID profile. If not set or if the specified method is not available for the user, the default MFA method will be used.

Valid values include:
.RS
.IP \(bu 2
PhoneAppNotification - Authenticator app push notification
.IP \(bu 2
CompanionAppsNotification - MFA via Outlook app/Authenticator Lite
.IP \(bu 2
PhoneAppOTP - Authenticator app verification code
.IP \(bu 2
OneWaySMS - Text message code
.IP \(bu 2
TwoWayVoiceMobile - Phone call to mobile
.IP \(bu 2
TwoWayVoiceAlternateMobile - Phone call to alternate mobile number
.IP \(bu 2
TwoWayVoiceOffice - Phone call to office
.IP \(bu 2
ConsolidatedTelephony - Call or text message
.RE

.P
Example: mfa_method = TwoWayVoiceMobile

.TP
.B cn_name_mapping
.RE
Allows users to enter the short form of their username (e.g., 'dave') instead of the full UPN.

.P
Default: true

.P
Example: cn_name_mapping = false

.TP
.B local_groups
.RE
A comma-separated list of local groups that every Entra ID user should be a member of. For example, you may wish for all Entra ID users to be a member of the sudo group. WARNING: This setting will not REMOVE group member entries when groups are removed from this list. You must remove them manually.

.P
Example: local_groups = sudo,admin

.TP
.B sudo_groups
.RE
A comma-separated list of Azure Entra ID group object IDs whose members should be granted
.B sudo
access on this system.
If
.B local_sudo_group
is not defined, the local group
.B sudo
will be used.

.P
Example: sudo_groups = f3c9a7e4-7d5a-47e8-832f-3d2d92abcd12,5ba4ef1d-e454-4f43-ba7c-6fe6f1601915

.TP
.B local_sudo_group
.RE
The local group that should be given to users in any of the groups specified in sudo_groups.
Only has an effect if sudo_groups is set.
Removes group from user if they are no longer a member of the specified entra group.

.P
Default: sudo

.TP
.B logon_script
.RE
A script that will execute every time a user logs on. Two environment variables are set: USERNAME, and ACCESS_TOKEN. The ACCESS_TOKEN environment variable is an access token for the MS Graph. The token scope config option sets the comma-separated scopes that should be requested for the ACCESS_TOKEN. ACCESS_TOKEN will be empty during offline logon. The return code of the script determines how authentication proceeds. 0 is success, 1 is a soft failure and authentication will proceed, while 2 is a hard failure causing authentication to fail.

.P
Example: logon_script = /etc/himmelblau/logon.sh

.TP
.B logon_token_scopes
.RE
A comma-separated list of the scopes to be requested for the ACCESS_TOKEN during logon. These scopes
.B MUST
correspond to the API permissions assigned to the Entra Id Application specified by the
.B app_id
option.

.P
Example: logon_token_scopes = user.read,mail.read

.TP
.B app_id
.RE
Specifies the Azure Entra ID application (client) ID used by Himmelblau for directory operations such as reading extended attributes (for example,
the
.B gidNumber
attribute used in RFC 2307 idmapping).

If
.B logon_token_app_id
is not set, this application ID is also used when requesting access tokens for the user logon script.

.PP
\fBNote:\fR In the Azure Portal for the application corresponding to \fBapp_id\fR, ensure that the redirect URI
\fIhimmelblau://Himmelblau.EntraId.BrokerPlugin\fR
is enabled under "Mobile and desktop applications" in the Authentication section.
This allows Himmelblau to correctly handle interactive token redirection.

.P
Example: app_id = d023f7aa-d214-4b59-911d-6074de623765

.TP
.B logon_token_app_id
.RE
Specifies an alternate Azure Entra ID application (client) ID to be used exclusively for acquiring
.B ACCESS_TOKEN
values on behalf of the user during logon script execution.
If not set, the value of
.B app_id
will be used instead.

This option allows using a separate application registration that carries the specific API permissions required by logon scripts.

.PP
\fBNote:\fR In the Azure Portal for the application corresponding to \fBlogon_token_app_id\fR, ensure that the redirect URI
\fIhttps://login.microsoftonline.com/common/oauth2/nativeclient\fR
is enabled under "Mobile and desktop applications" in the Authentication section.
This is required for Himmelblau to obtain tokens via the public client flow.

.P
Example: logon_token_app_id = 544e695f-5d78-442e-b14e-e114e95e640c

.TP
.B enable_experimental_mfa
.RE
A boolean option that enables the experimental multi-factor authentication (MFA) flow, which permits Hello authentication. This experimental flow may encounter failures in certain edge cases. If disabled, the system enforces the Device Authorization Grant (DAG) flow for MFA, which is more robust but does not support Hello authentication.

.P
Default: true

.P
Example: enable_experimental_mfa = false

.TP
.B enable_experimental_passwordless_fido
.RE
A boolean option that enables the experimental passwordless FIDO flow for Azure Entra ID authentication. When enabled, Himmelblau will attempt to authenticate with Entra ID using a FIDO2 security key without requiring a password.

.P
Default: false

.P
Example: enable_experimental_passwordless_fido = true

.TP
.B name_mapping_script
.RE
Specifies the path to an executable script used for mapping custom names to UPN names. The script MUST accept a single argument, which will always be a mapped name. The script MUST print the corresponding UPN (User Principal Name) to stdout. If the script does not recognize the input name, it MUST simply return the input name unchanged. This option is particularly useful in environments where direct UPN-to-CN mappings are impractical or where custom transformations are required.

The script must handle the input gracefully and return the correct UPN or the input name if unrecognized. Errors must be handled to avoid authentication failures.

Example Script:
.RS 4
.nf
#!/bin/bash
# Convert CN to UPN, or return the input name if unrecognized
if [[ "$1" =~ ^[a-zA-Z0-9._-]+$ ]]; then
    echo "$1@example.com"
else
    echo "$1"
fi
.fi
.RE

.P
Example: name_mapping_script = /path/to/mapping_script.sh

.TP
.B apply_policy
.RE
A boolean option that enables the application and enforcement of Intune policies to the authenticated user.

.P
Default: false

.P
Example: apply_policy = true

.TP
.B authority_host
.RE
Specifies the hostname for Microsoft authentication.

.P
Default: login.microsoftonline.com

.P
Example: authority_host = login.microsoftonline.us

.TP
.B db_path
.RE
The location of the cache database. This file is used to store cached authentication data and device state.

.P
Default: /var/cache/himmelblaud/himmelblau.cache.db

.P
Example: db_path = /var/cache/himmelblau/himmelblau.cache.db

.TP
.B hsm_type
.RE
Specifies how Himmelblau should handle secure key storage. This option determines whether to use a TPM (Trusted Platform Module) bound software-based HSM, a TPM, or a hybrid approach.

The available options are:

\(bu
.B tpm_bound_soft_if_possible
\(en Use a software-based HSM that encrypts key material locally on the system, but binds the parent AuthCode to the TPM, if available.

\(bu
.B tpm
\(en Use a hardware TPM exclusively for storing and binding cryptographic keys.

\(bu
.B tpm_if_possible
\(en Attempt to use a hardware TPM if available; if not, fall back to the software HSM. If the TPM has previously been used for key storage, the system will not fall back to the software HSM.

This setting is important for protecting sensitive cryptographic keys in a secure environment, reducing the risk of compromise if the system is breached.

Note that the old
.B soft
option has been deprecated. Environments currently enrolled using
.B soft
will be automatically migrated to
.B tpm_bound_soft_if_possible.

To validate whether Himmelblau is utilizing the hardware TPM, run the command `sudo aad-tool tpm` for a status report.

.P
Default: tpm_bound_soft_if_possible

.P
Example: hsm_type = tpm

.TP
.B tpm_tcti_name
.RE
Specifies the TCTI (Trusted Computing Technology Interface) to use when communicating with a Trusted Platform Module (TPM) for secure key operations. This setting is only relevant when
.B hsm_type
is set to
.B tpm
or
.B tpm_if_possible.

Common values include:

\(bu
.B device:/dev/tpmrm0
\(en This uses the kernel TPM resource manager device, which is the recommended default for most Linux systems.

Other TCTI strings may be required depending on your system's TPM driver or configuration. This option allows advanced control over how Himmelblau connects to the TPM for performing cryptographic operations.

.P
Default: device:/dev/tpmrm0

.P
Example: tpm_tcti_name = device:/dev/tpm0

.TP
.B hsm_pin_path
.RE
The location where the HSM (Hardware Security Module) PIN will be stored. This PIN is used to protect sensitive cryptographic operations.

.P
Default: /var/lib/himmelblaud/hsm-pin

.P
Example: hsm_pin_path = /etc/himmelblau/hsm-pin

.TP
.B socket_path
.RE
The path to the socket file for communication between the pam and nss modules and the Himmelblau daemon.

.P
Default: /var/run/himmelblaud/socket

.P
Example: socket_path = /tmp/himmelblaud.sock

.TP
.B task_socket_path
.RE
The path to the socket file for communication with the task daemon.

.P
Default: /var/run/himmelblaud/task_sock

.P
Example: task_socket_path = /tmp/task.sock

.TP
.B broker_socket_path
.RE
The path to the socket file for communication with the broker DBus service.

.P
Default: /var/run/himmelblaud/broker_sock

.P
Example: broker_socket_path = /tmp/broker.sock

.TP
.B home_prefix
.RE
The prefix to use for user home directories.

.P
Default: /home/

.P
Example: home_prefix = /home/entra/

.TP
.B home_attr
.RE
The attribute used to create a home directory for a user. Available options include:
.RS
.IP
\- UUID
.IP
\- SPN
.IP
\- CN
.RE

.P
Default: uuid

.P
Example: home_attr = UUID

.TP
.B home_alias
.RE
The symlinked alias for the user's home directory. Available options include:
.RS
.IP
\- UUID
.IP
\- SPN
.IP
\- CN
.RE

.P
Default: spn

.P
Example: home_alias = SPN

.TP
.B shell
.RE
The default shell for users. This will be assigned when the user logs in.

.P
Default: /bin/bash

.P
Example: shell = /bin/zsh

.TP
.B idmap_range
.RE
Specifies the range of IDs to be used for the user and group mappings.

When this option is modified, you
.B SHOULD
run:
.RS
.IP
sudo aad-tool cache-clear --full
.RE

To ensure that old cached ID mappings are cleared, preventing potential UID overlaps caused by stale cache data. Afterwards, restart himmelblaud.

.P
Default: 200000-2000200000

.P
Example: idmap_range = 10000000-10999999

.TP
.B connection_timeout
.RE
The timeout in seconds for connections to the authentication server.

.P
Default: 30

.P
Example: connection_timeout = 5

.TP
.B subid_range
.RE
Specifies the range of subordinate IDs (subuid/subgid) to be allocated for container support (podman, rootless containers, etc.).

Himmelblau will automatically add entries to /etc/subuid and /etc/subgid for each user at login. Each user receives a 65536-ID slice from this range, allocated deterministically based on a hash of their username.

This feature is enabled by default with the default range shown below.

.P
Default: 2100000000-4200000000

.P
Example: subid_range = 2100000000-4200000000

.TP
.B cache_timeout
.RE
The timeout in seconds for caching authentication data.

.P
Default: 300

.P
Example: cache_timeout = 10

.TP
.B use_etc_skel
.RE
If set to
.B true,
Himmelblau will use the contents of /etc/skel when creating new user directories.

.P
Default: false

.P
Example: use_etc_skel = true

.TP
.B selinux
.RE
Whether SELinux security labels should be applied to users' home directories. Set to
.B true
to enable.

.P
Default: true

.P
Example: selinux = false

.TP
.B join_type
.RE
Specifies whether the system should join or register with Microsoft Entra ID.

.P
Default: join

.P
Example: join_type = register

.TP
.B user_map_file
.RE
Specifies the path to a user-mapping file used to map local user accounts to Azure Entra ID user accounts, allowing them to authenticate using Entra ID credentials.

Each line of the file must contain a single mapping entry in the format:
.IP
local_username:name@domain
.PP
Blank lines and lines beginning with '#' are ignored.

Example user-map file entries:
.RS 4
.nf
# local_username:samaccountname@domain
alice:alice@contoso.com
bob:bob.smith@example.org
svcuser:service.account@tenant.local
.fi
.RE

.P
Default: /etc/himmelblau/user-map

.P
Example: user_map_file = /path/to/user_map

.SH OFFLINE BREAKGLASS CONFIGURATION
The
.B [offline_breakglass]
section configures Himmelblau's emergency offline authentication mechanism,
used when Azure Entra ID is unavailable.

.P
Offline breakglass allows Entra ID users who normally require multi-factor authentication (MFA)
to authenticate with their cached password when the host is offline.
This feature provides a controlled fallback for MFA-only users who would otherwise be unable
to sign in during an outage.

.P
Single-factor authentication (SFA-only) users and Hello-PIN users
already have offline sign-in capability, and are unaffected by this setting.
This option exists solely to extend limited offline access to
MFA-enabled users when network connectivity to Entra ID cannot be established.

.SS [offline_breakglass]
This section controls whether and how Himmelblau may perform offline password authentication
for MFA-enabled users in emergency conditions.

.TP
.B enabled
.RE
Boolean value specifying whether offline breakglass mode is permitted.

.P
When set to
.B true,
Himmelblau will cache secure, salted password verifiers for
.B MFA-enabled
Entra ID users who successfully authenticate online.
These verifiers can then be used to authenticate the same users when Entra ID is unreachable,
allowing MFA users to log in using their cached password.

.P
If this option is set to
.B false,
Himmelblau will continue to cache password verifiers only for SFA-only users,
and MFA-enabled users will
.B not
be able to authenticate when offline.
The
.BR aad-tool (1)
command
.B aad-tool offline-breakglass
will also have no effect.

.P
Administrators must enable this option well in advance of an outage,
as password verifiers for MFA users are only stored following a successful online authentication.
It is too late to enable this feature once Entra ID is already unreachable.

.P
Enabling offline breakglass mode carries significant risk.
If a device is stolen or compromised, and network access to Entra ID is blocked,
attackers could effectively disable MFA protection by forcing the system into
a simple password-only (SFA) authentication state.
Administrators should enable this mode
.B only after careful consideration
of their organization's security posture and offline access requirements.

.P
This feature does not apply to passwordless accounts.
If an MFA user signs in using a passwordless method,
no password hash exists to cache, and offline breakglass cannot function for that user.

.P
Default: false

.P
Example: [offline_breakglass]
.br
enabled = true
.br
ttl = 2h
.br
# Allow MFA users to authenticate offline for up to 2 hours

.TP
.B ttl
.RE
Specifies how long breakglass mode should remain active once triggered.
The value may include a suffix to indicate the unit of time:
.B m
for minutes,
.B h
for hours, or
.B d
for days.
If no suffix is provided, the value is interpreted as seconds.
After the specified period, offline breakglass mode automatically expires
and normal authentication resumes.

.P
Default: 7200

.P
Example: [offline_breakglass]
.br
enabled = true
.br
ttl = 1d
.br
# Permit offline MFA logins for up to 24 hours after activation

.SH SEE ALSO
.BR himmelblaud(8),
.BR himmelblaud-tasks(8)
